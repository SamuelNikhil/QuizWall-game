#!/bin/sh

# Environment variable substitution script for nginx
# This script reads .env file and generates nginx configuration

ENV_FILE="/etc/nginx/.env"

if [ -f "$ENV_FILE" ]; then
    # Extract server URL and port from .env
    SERVER_URL=$(grep VITE_SERVER_URL "$ENV_FILE" | cut -d '=' -f2)
    SERVER_PORT=$(grep VITE_SERVER_PORT "$ENV_FILE" | cut -d '=' -f2)
    
    # Remove protocol from URL for nginx backend
    BACKEND_HOST=$(echo "$SERVER_URL" | sed 's|https://||' | sed 's|http://||')
    
    # Combine host and port
    if [ -n "$SERVER_PORT" ] && [ "$SERVER_PORT" != "443" ] && [ "$SERVER_PORT" != "80" ]; then
        BACKEND_SERVER="$BACKEND_HOST:$SERVER_PORT"
    else
        BACKEND_SERVER="$BACKEND_HOST"
    fi
    
    # Export for nginx
    export BACKEND_SERVER
    
    echo "Backend server configured as: $BACKEND_SERVER"
else
    echo "No .env file found, using default backend server"
    export BACKEND_SERVER="13.127.217.1:3000"
fi

# Start nginx with environment substitution
exec nginx -g "daemon off;"
